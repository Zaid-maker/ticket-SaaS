---
title: Authentication
description: Learn about the authentication system using Better Auth
---

# Authentication

This application uses [Better Auth](https://www.better-auth.com/) for comprehensive user authentication with support for email/password and GitHub OAuth.

## Features

- ✅ Email/Password authentication
- ✅ GitHub OAuth authentication
- ✅ Secure password hashing with bcrypt
- ✅ Session management with automatic refresh
- ✅ Protected routes (Dashboard, Create Ticket, Purchase)
- ✅ User-specific data (own tickets, purchases)
- ✅ Rate limiting on authentication endpoints

## Authentication Methods

### Email/Password

Users can create accounts using their email address and a password.

**Password Requirements:**
- Minimum 8 characters
- Passwords are hashed with bcrypt (cost factor 10)
- Never stored in plain text

### GitHub OAuth

Users can authenticate using their GitHub account for quick and secure sign-in.

**Setup:** See [Configuration - GitHub OAuth](/docs/configuration#github-oauth-configuration)

## Authentication Pages

### Sign Up (`/auth/signup`)

Create a new account with:
- Email and password
- Name (optional)
- Or use GitHub OAuth

Features:
- Real-time validation
- Automatic sign-in after registration
- Redirect to dashboard upon success

### Sign In (`/auth/login`)

Sign in to existing account with:
- Email and password
- Or use GitHub OAuth

Features:
- Error handling for invalid credentials
- Session creation and management
- Redirect to dashboard upon success

## Protected Routes

The following routes require authentication:

- `/dashboard` - View your tickets and purchases
- `/tickets/create` - List new tickets for sale
- Purchase functionality on ticket detail pages

**Behavior:**
- Unauthenticated users are redirected to `/auth/login`
- After login, users are redirected back to the original page

## API Endpoints

### Authentication Endpoints

All authentication endpoints are handled by Better Auth at `/api/auth/[...all]`:

- `POST /api/auth/sign-up` - Create new account
- `POST /api/auth/sign-in` - Sign in
- `POST /api/auth/sign-out` - Sign out
- `GET /api/auth/session` - Get current session
- `GET /api/auth/callback/github` - GitHub OAuth callback

**Rate Limiting:** 20 requests per 15 minutes per IP address

### Protected API Routes

These API routes require authentication:

- `POST /api/tickets` - Create a ticket (seller is automatically set to current user)
- `POST /api/purchases` - Purchase tickets (buyer is automatically set to current user)

## Security Features

### Password Security

- Passwords hashed using bcrypt (cost factor 10)
- Minimum password length of 8 characters
- Never stored in plain text
- Salted hashing prevents rainbow table attacks

### Session Security

- Sessions expire after 7 days of inactivity
- Session tokens are securely generated
- Automatic session refresh every 24 hours
- Sessions invalidated on sign out
- Stored in database for persistence

### Cookie Security

- HTTP-only cookies (not accessible via JavaScript)
- Secure flag in production (HTTPS only)
- SameSite attribute to prevent CSRF attacks
- Automatic cleanup of expired sessions

### API Security

- All protected routes check for valid session
- User data is isolated (users can only access their own tickets and purchases)
- CSRF protection via Better Auth
- Rate limiting on all API endpoints

### Rate Limiting

All API endpoints are protected with rate limiting:

**Authentication Endpoints** (`/api/auth/*`):
- Limit: 20 requests per 15 minutes per IP
- Purpose: Prevents brute force attacks

**Other Endpoints:**
- Ticket GET: 30 requests per minute
- Ticket POST: 10 requests per minute
- Purchase POST: 5 requests per minute

**Rate Limit Response:**
```json
{
  "error": "Too many requests. Please try again later.",
  "retryAfter": 45
}
```

## Client-Side Usage

### Check Authentication Status

Use the `useSession` hook in client components:

```tsx
"use client";

import { useSession } from "@/lib/auth-client";

export function MyComponent() {
  const { data: session, isPending } = useSession();
  
  if (isPending) {
    return <div>Loading...</div>;
  }
  
  if (!session) {
    return <div>Please sign in</div>;
  }
  
  return <div>Hello, {session.user.name}!</div>;
}
```

### Sign Out

```tsx
import { authClient } from "@/lib/auth-client";
import { useRouter } from "next/navigation";

function SignOutButton() {
  const router = useRouter();
  
  const handleSignOut = async () => {
    await authClient.signOut();
    router.push("/");
    router.refresh();
  };
  
  return <button onClick={handleSignOut}>Sign Out</button>;
}
```

### Conditional Rendering

```tsx
import { useSession } from "@/lib/auth-client";

export function NavBar() {
  const { data: session } = useSession();
  
  return (
    <nav>
      {session ? (
        <>
          <Link href="/dashboard">Dashboard</Link>
          <Link href="/tickets/create">Create Ticket</Link>
        </>
      ) : (
        <>
          <Link href="/auth/login">Sign In</Link>
          <Link href="/auth/signup">Sign Up</Link>
        </>
      )}
    </nav>
  );
}
```

## Server-Side Usage

### Get Current Session

Use `getSession` in server components:

```tsx
import { getSession } from "@/lib/session";
import { redirect } from "next/navigation";

export default async function DashboardPage() {
  const session = await getSession();
  
  if (!session) {
    redirect("/auth/login");
  }
  
  return (
    <div>
      <h1>Welcome, {session.user.name}!</h1>
      <p>Email: {session.user.email}</p>
    </div>
  );
}
```

### Require Authentication

Use `requireAuth` to enforce authentication in API routes:

```tsx
import { requireAuth } from "@/lib/session";
import { NextRequest, NextResponse } from "next/server";

export async function POST(request: NextRequest) {
  const session = await requireAuth();
  
  // User is authenticated, session.user contains user data
  const data = await request.json();
  
  // Use session.user.id for user-specific operations
  const ticket = await prisma.ticket.create({
    data: {
      ...data,
      sellerId: session.user.id,
    },
  });
  
  return NextResponse.json(ticket);
}
```

### Check Authorization

```tsx
import { getSession } from "@/lib/session";
import { prisma } from "@/lib/prisma";

export async function DELETE(
  request: NextRequest,
  { params }: { params: { id: string } }
) {
  const session = await getSession();
  
  if (!session) {
    return new Response("Unauthorized", { status: 401 });
  }
  
  const ticket = await prisma.ticket.findUnique({
    where: { id: params.id },
  });
  
  if (ticket?.sellerId !== session.user.id) {
    return new Response("Forbidden", { status: 403 });
  }
  
  // User owns the ticket, proceed with deletion
  await prisma.ticket.delete({ where: { id: params.id } });
  
  return new Response(null, { status: 204 });
}
```

## Production Considerations

### Environment Variables

**Required in production:**
```bash
NODE_ENV=production
DATABASE_URL="postgresql://user:password@host:5432/db"
BETTER_AUTH_SECRET="strong-random-secret-at-least-32-chars"
BETTER_AUTH_URL="https://yourdomain.com"
```

**Generate secure secret:**
```bash
openssl rand -base64 32
```

### HTTPS Configuration

- ✅ HTTPS-only cookies automatically enabled in production
- ✅ HTTP Strict Transport Security (HSTS) headers
- ✅ Session cookies only transmitted over HTTPS
- Always deploy behind HTTPS (nginx, Vercel, etc.)

### Rate Limiting

- ✅ Implemented on all API routes
- In-memory storage (resets on server restart)
- For multiple servers, consider Redis or distributed cache
- Adjust limits based on your needs

### Future Enhancements

Consider implementing:

1. **Email Verification**: Confirm email addresses before activation
2. **Password Reset**: Allow users to recover forgotten passwords
3. **Two-Factor Authentication**: Add extra security layer
4. **OAuth Providers**: Add Google, Twitter, etc.
5. **Session Management**: View and revoke active sessions
6. **Security Notifications**: Alert users of suspicious activity

## Troubleshooting

### "Unauthorized" errors

**Causes:**
- Not signed in
- Session expired
- Invalid `BETTER_AUTH_SECRET`
- Wrong `BETTER_AUTH_URL` in production

**Solutions:**
- Sign in again
- Check environment variables
- Clear browser cookies
- Verify database connection

### Cannot create tickets/purchases

**Causes:**
- Not authenticated
- Session not being passed correctly
- Rate limit exceeded

**Solutions:**
- Verify authentication status
- Check browser console for errors
- Wait and retry if rate limited
- Verify API route receives session

### Auth requests to localhost in production

**Cause:** `NEXT_PUBLIC_BETTER_AUTH_URL` set to localhost

**Solution:** Remove `NEXT_PUBLIC_BETTER_AUTH_URL` in production (app uses relative URLs)

### Session not persisting

**Causes:**
- Cookies disabled
- `BETTER_AUTH_URL` mismatch
- Database not accessible

**Solutions:**
- Enable cookies in browser
- Verify `BETTER_AUTH_URL` matches domain
- Check database connectivity
- Clear browser cookies and sign in again

### GitHub OAuth not working

**Causes:**
- Invalid client ID/secret
- Wrong callback URL
- OAuth app suspended

**Solutions:**
- Verify credentials in `.env`
- Check callback URL: `[BETTER_AUTH_URL]/api/auth/callback/github`
- Verify OAuth app is active in GitHub settings

## Demo Account

After running `npx prisma db seed`:

- **Email:** demo@ticketsaas.com
- **Password:** demo1234

## Additional Resources

- [Better Auth Documentation](https://www.better-auth.com/docs)
- [Configuration Guide](/docs/configuration)
- [API Reference](/docs/api)
- [Security Best Practices](https://owasp.org/www-project-top-ten/)
