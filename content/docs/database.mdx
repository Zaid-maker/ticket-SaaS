---
title: Database Setup
description: Configure, migrate, and seed your PostgreSQL database
---

# Database Setup

This guide explains how to set up and manage the PostgreSQL database for the Ticket Marketplace SaaS application.

## Prerequisites

- PostgreSQL installed and running
- Database connection URL configured in `.env`
- Prisma CLI installed (via npm/bun)

## Initial Setup

### 1. Generate Prisma Client

This step requires internet access to download Prisma engines:

```bash
npx prisma generate
```

If this fails due to network restrictions, you can:
- Try again on a different network
- Use a proxy or VPN
- Set `PRISMA_ENGINES_MIRROR` environment variable

### 2. Run Migrations

Apply all database migrations to create the required tables:

```bash
npx prisma migrate deploy
```

For development (creates migration files):
```bash
npx prisma migrate dev
```

### 3. Seed the Database (Optional)

Populate the database with sample data including a demo user and sample tickets:

```bash
npx prisma db seed
```

This creates:
- Demo user account (demo@ticketsaas.com / demo1234)
- Sample tickets across different categories
- Example purchase records

## Database Schema

### User Model

Stores user account information for authentication.

```prisma
model User {
  id        String   @id @default(cuid())
  name      String
  email     String   @unique
  emailVerified DateTime?
  image     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  tickets   Ticket[]
  purchases Purchase[]
  sessions  Session[]
  accounts  Account[]
}
```

**Fields:**
- `id`: Unique identifier (CUID)
- `name`: User's display name
- `email`: User's email address (unique)
- `emailVerified`: Timestamp of email verification
- `image`: Profile image URL
- `createdAt`: Account creation timestamp
- `updatedAt`: Last update timestamp

### Session Model

Manages user authentication sessions.

```prisma
model Session {
  id        String   @id @default(cuid())
  sessionToken String @unique
  userId    String
  expiresAt DateTime
  ipAddress String?
  userAgent String?
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}
```

**Features:**
- 7-day session expiration
- Automatic refresh every 24 hours
- IP address and user agent tracking

### Account Model

Stores OAuth provider accounts and password credentials.

```prisma
model Account {
  id           String  @id @default(cuid())
  userId       String
  accountId    String
  providerId   String
  accessToken  String?
  refreshToken String?
  idToken      String?
  expiresAt    DateTime?
  password     String?
  
  user         User    @relation(fields: [userId], references: [id], onDelete: Cascade)
}
```

### Ticket Model

Represents event tickets available for sale.

```prisma
model Ticket {
  id          String   @id @default(cuid())
  title       String
  description String
  price       Float
  category    Category
  eventDate   DateTime
  location    String
  quantity    Int
  available   Int
  sellerId    String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  seller      User     @relation(fields: [sellerId], references: [id])
  purchases   Purchase[]
}
```

**Categories:**
- `CONCERT` - Music concerts and festivals
- `SPORTS` - Sports events
- `THEATER` - Theater shows and performances
- `FESTIVAL` - Festivals and special events

### Purchase Model

Tracks ticket purchases and transactions.

```prisma
model Purchase {
  id        String   @id @default(cuid())
  ticketId  String
  buyerId   String
  quantity  Int
  total     Float
  createdAt DateTime @default(now())
  
  ticket    Ticket   @relation(fields: [ticketId], references: [id])
  buyer     User     @relation(fields: [buyerId], references: [id])
}
```

### Verification Model

Manages email verification tokens.

```prisma
model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
}
```

## Database Operations

### View Data with Prisma Studio

Open a GUI to view and edit your database:

```bash
npx prisma studio
```

This opens a browser interface at http://localhost:5555

### Reset Database

**Warning:** This will delete all data!

```bash
npx prisma migrate reset
```

This will:
1. Drop the database
2. Create a new database
3. Apply all migrations
4. Run seed script

### Create New Migration

After modifying `prisma/schema.prisma`:

```bash
npx prisma migrate dev --name description_of_changes
```

### Check Migration Status

View which migrations have been applied:

```bash
npx prisma migrate status
```

## Backup and Restore

### Create Backup

```bash
pg_dump -U username -d ticketsaas > backup.sql
```

### Restore Backup

```bash
psql -U username -d ticketsaas < backup.sql
```

## Performance Optimization

### Indexes

The schema includes indexes on frequently queried fields:

- `User.email` - Unique index for login
- `Session.sessionToken` - Unique index for session lookup
- `Ticket.category` - Index for category filtering
- `Ticket.sellerId` - Index for user's tickets
- `Purchase.buyerId` - Index for user's purchases

### Query Optimization

Use Prisma's relation loading efficiently:

```typescript
// ✅ Good - Explicit include
const ticket = await prisma.ticket.findUnique({
  where: { id },
  include: { seller: true }
});

// ❌ Avoid - Loading unnecessary data
const tickets = await prisma.ticket.findMany({
  include: { 
    seller: true,
    purchases: { include: { buyer: true } }
  }
});
```

## Troubleshooting

### "P1001: Can't reach database server"

- Check that PostgreSQL is running
- Verify `DATABASE_URL` in `.env`
- Check firewall settings

### "P3009: Migrate finds failed migrations"

Reset the migration history:
```bash
npx prisma migrate resolve --applied [migration_name]
```

### "P2002: Unique constraint failed"

- Check for duplicate data
- Verify unique fields (email, sessionToken)
- Review seed script for conflicts

### Migration Conflicts

If migrations conflict, you may need to:
1. Backup your data
2. Reset migrations
3. Create a new migration
4. Restore data

## Production Considerations

### Connection Pooling

For production, consider using a connection pooler like PgBouncer:

```bash
DATABASE_URL="postgresql://user:password@pgbouncer:6432/ticketsaas?pgbouncer=true"
```

### Read Replicas

Configure read replicas for better performance:

```typescript
const prisma = new PrismaClient({
  datasources: {
    db: {
      url: process.env.DATABASE_URL_REPLICA,
    },
  },
});
```

### SSL Configuration

Enable SSL for production databases:

```bash
DATABASE_URL="postgresql://user:password@host:5432/db?sslmode=require"
```

## Next Steps

- [Authentication](/docs/authentication) - Set up user authentication
- [API Routes](/docs/api) - Learn about the API endpoints
- [Deployment](/docs/deployment) - Deploy to production
